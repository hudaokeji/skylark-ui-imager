/**
 * skylark-ui-imager - The skylark imager widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-imager/
 * @license MIT
 */
!function(t,i){function e(t,i){if("."!==t[0])return t;var e=i.split("/"),n=t.split("/");e.pop();for(var s=0;s<n.length;s++)"."!=n[s]&&(".."==n[s]?e.pop():e.push(n[s]));return e.join("/")}var n=i.define,s=i.require,a="function"==typeof n&&n.amd,o=!a&&"undefined"!=typeof exports;if(!a&&!n){var r={};n=i.define=function(t,i,n){"function"==typeof n?(r[t]={factory:n,deps:i.map(function(i){return e(i,t)}),exports:null},s(t)):r[t]=n},s=i.require=function(t){if(!r.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var i=r[t];if(!i.exports){var e=[];i.deps.forEach(function(t){e.push(s(t))}),i.exports=i.factory.apply(window,e)}return i.exports}}if(!n)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(t(n,s),!a){var h=s("skylark-langx/skylark");o?exports=h:i.skylarkjs=h}}(function(t,i){t("skylark-ui-imager/Imager",["skylark-langx/skylark","skylark-langx/langx","skylark-utils/noder","skylark-utils/finder","skylark-utils/widgets","skylark-utils-canvas2d"],function(t,i,e,n,s,a,o){"use strict";function r(t){return{height:Math.abs(t.getWidth()*Math.sin(t.getAngle()*Math.PI/180))+Math.abs(t.getHeight()*Math.cos(t.getAngle()*Math.PI/180)),width:Math.abs(t.getHeight()*Math.sin(t.getAngle()*Math.PI/180))+Math.abs(t.getWidth()*Math.cos(t.getAngle()*Math.PI/180))}}function h(t){this.element=t}function l(t){this.element=t}function c(t){this.element=t}var g=t.ui=t.ui||{},u={};h.prototype={createButtonGroup:function(t){var i=document.createElement("div");return i.className="darkroom-button-group",this.element.appendChild(i),new l(i)}},l.prototype={createButton:function(t){var e={image:"help",type:"default",group:"default",hide:!1,disabled:!1};t=i.mixin({},e,t);var n=document.createElement("button");n.type="button",n.className="darkroom-button darkroom-button-"+t.type,n.innerHTML='<svg class="darkroom-icon"><use xlink:href="#'+t.image+'" /></svg>',this.element.appendChild(n);var s=new c(n);return s.hide(t.hide),s.disable(t.disabled),s}},c.prototype={addEventListener:function(t,i){this.element.addEventListener?this.element.addEventListener(t,i):this.element.attachEvent&&this.element.attachEvent("on"+t,i)},removeEventListener:function(t,i){this.element.removeEventListener&&this.element.removeEventListener(t,i)},active:function(t){t?this.element.classList.add("darkroom-button-active"):this.element.classList.remove("darkroom-button-active")},hide:function(t){t?this.element.classList.add("darkroom-button-hidden"):this.element.classList.remove("darkroom-button-hidden")},disable:function(t){this.element.disabled=!!t}};var d=s.Widget.inherit({klassName:"Imager",init:function(t,e,s){"string"==typeof t&&(t=n.find(t)),this._initializeDOM(t),this.overrided(this.containerElement,e),this.options=i.mixin({},this.defaults,e),this.plugins={},this._initializeImage(),this._initializePlugins(),this.refresh(function(){this.options.initialize.bind(this).call()}.bind(this))},containerElement:null,canvas:null,image:null,sourceCanvas:null,sourceImage:null,originalImageElement:null,transformations:[],defaults:{minWidth:null,minHeight:null,maxWidth:null,maxHeight:null,ratio:null,backgroundColor:"#fff",plugins:{},initialize:function(){}},selfDestroy:function(){var t=this.containerElement,i=new Image;i.onload=function(){t.parentNode.replaceChild(i,t)},i.src=this.sourceImage.toDataURL()},addEventListener:function(t,i){var e=this.canvas.getElement();e.addEventListener?e.addEventListener(t,i):e.attachEvent&&e.attachEvent("on"+t,i)},dispatchEvent:function(t){var i=document.createEvent("Event");i.initEvent(t,!0,!0),this.canvas.getElement().dispatchEvent(i)},refresh:function(t){var i=new Image;i.onload=function(){this._replaceCurrentImage(new a.Image(i)),t&&t()}.bind(this),i.src=this.sourceImage.toDataURL()},_replaceCurrentImage:function(t){this.image&&this.image.remove(),this.image=t,this.image.selectable=!1;var i=r(this.image),e=i.width,n=i.height;if(null!==this.options.ratio){var s=+this.options.ratio,a=e/n;a>s?n=e/s:a<s&&(e=n*s)}var o=1,h=1,l=1,c=1;null!==this.options.maxWidth&&this.options.maxWidth<e&&(l=this.options.maxWidth/e),null!==this.options.maxHeight&&this.options.maxHeight<n&&(c=this.options.maxHeight/n),o=Math.min(l,c),l=1,c=1,null!==this.options.minWidth&&this.options.minWidth>e&&(l=this.options.minWidth/e),null!==this.options.minHeight&&this.options.minHeight>n&&(c=this.options.minHeight/n),h=Math.max(l,c);var g=h*o;e*=g,n*=g,this.image.setScaleX(1*g),this.image.setScaleY(1*g),this.canvas.add(this.image),this.canvas.setWidth(e),this.canvas.setHeight(n),this.canvas.centerObject(this.image),this.image.setCoords()},applyTransformation:function(t){this.transformations.push(t),t.applyTransformation(this.sourceCanvas,this.sourceImage,this._postTransformation.bind(this))},_postTransformation:function(t){t&&(this.sourceImage=t),this.refresh(function(){this.dispatchEvent("core:transformation")}.bind(this))},reinitializeImage:function(){this.sourceImage.remove(),this._initializeImage(),this._popTransformation(this.transformations.slice())},_popTransformation:function(t){if(0===t.length)return this.dispatchEvent("core:reinitialized"),void this.refresh();var i=t.shift(),e=function(i){i&&(this.sourceImage=i),this._popTransformation(t)};i.applyTransformation(this.sourceCanvas,this.sourceImage,e.bind(this))},_initializeDOM:function(t){var i=document.createElement("div");i.className="darkroom-container";var e=document.createElement("div");e.className="darkroom-toolbar",i.appendChild(e);var n=document.createElement("div");n.className="darkroom-image-container";var s=this.canvasElement=document.createElement("canvas");n.appendChild(s),i.appendChild(n);var a=document.createElement("div");a.className="darkroom-source-container",a.style.display="none";var o=this.sourceCanvasElement=document.createElement("canvas");a.appendChild(o),i.appendChild(a),t.parentNode.replaceChild(i,t),t.style.display="none",i.appendChild(t),this.containerElement=i,this.originalImageElement=t,this.toolbar=new h(e)},_initializeImage:function(){this.canvas=new a.Canvas(this.canvasElement,{selection:!1,backgroundColor:this.options.backgroundColor}),this.sourceCanvas=new a.Canvas(this.sourceCanvasElement,{selection:!1,backgroundColor:this.options.backgroundColor}),this.sourceImage=new a.Image(this.originalImageElement,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),this.sourceCanvas.add(this.sourceImage);var t=r(this.sourceImage),i=t.width,e=t.height;this.sourceCanvas.setWidth(i),this.sourceCanvas.setHeight(e),this.sourceCanvas.centerObject(this.sourceImage),this.sourceImage.setCoords()},_initializePlugins:function(){for(var t in u){var i=u[t],e=this.options.plugins[t];e!==!1&&u.hasOwnProperty(t)&&(this.plugins[t]=new i.ctor(this,e))}}});return d.Plugin=i.Evented.inherit({klassName:"Plugin",defaults:{},init:function(t,e){this.imager=t,this.options=i.mixin({},this.defaults,e)}}),d.Transformation=i.Evented.inherit({klassName:"Transformation",init:function(t){this.options=t}}),d.installPlugin=function(t){u[t.name]=t},g.Imager=d}),t("skylark-ui-imager/plugins/history",["skylark-langx/langx","skylark-utils/noder","skylark-utils/query","skylark-utils-canvas2d","../Imager"],function(t,i,e,n,s){"use strict";var a=s.Plugin.inherit({undoTransformations:null,init:function(t,i){this.overrided(t,i),this.undoTransformations=[],this._initButtons(),this.imager.addEventListener("core:transformation",this._onTranformationApplied.bind(this))},undo:function(){if(0!==this.imager.transformations.length){var t=this.imager.transformations.pop();this.undoTransformations.unshift(t),this.imager.reinitializeImage(),this._updateButtons()}},redo:function(){if(0!==this.undoTransformations.length){var t=this.undoTransformations.shift();this.imager.transformations.push(t),this.imager.reinitializeImage(),this._updateButtons()}},_initButtons:function(){var t=this.imager.toolbar.createButtonGroup();return this.backButton=t.createButton({image:"undo",disabled:!0}),this.forwardButton=t.createButton({image:"redo",disabled:!0}),this.backButton.addEventListener("click",this.undo.bind(this)),this.forwardButton.addEventListener("click",this.redo.bind(this)),this},_updateButtons:function(){this.backButton.disable(0===this.imager.transformations.length),this.forwardButton.disable(0===this.undoTransformations.length)},_onTranformationApplied:function(){this.undoTransformations=[],this._updateButtons()}}),o={name:"history",ctor:a};return s.installPlugin(o),o}),t("skylark-ui-imager/plugins/crop",["skylark-langx/langx","skylark-utils/noder","skylark-utils/images","skylark-utils/query","skylark-utils-canvas2d","../Imager"],function(t,i,e,n,s,a){"use strict";function o(t){return{height:Math.abs(t.getWidth()*Math.sin(t.getAngle()*Math.PI/180))+Math.abs(t.getHeight()*Math.cos(t.getAngle()*Math.PI/180)),width:Math.abs(t.getHeight()*Math.sin(t.getAngle()*Math.PI/180))+Math.abs(t.getWidth()*Math.cos(t.getAngle()*Math.PI/180))}}var r=a.Transformation.inherit({applyTransformation:function(t,i,n){var a=new Image,r=o(i),h=r.width,l=r.height,c=this.options.left*h,g=this.options.top*l,u=Math.min(this.options.width*h,h-c),d=Math.min(this.options.height*l,l-g);a.src=t.toDataURL({left:c,top:g,width:u,height:d}),e.loaded(a).then(function(){if(!(r<1||o<1)){var e=new s.Image(a,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),o=a.width,r=a.height;t.setWidth(o),t.setHeight(r),i.remove(),t.add(e),n(e)}})}}),h=s.util.createClass(s.Rect,{_render:function(t){this.callSuper("_render",t);var i=(t.canvas,7),e=this.flipX?-1:1,n=this.flipY?-1:1,s=e/this.scaleX,a=n/this.scaleY;t.scale(s,a),t.fillStyle="rgba(0, 0, 0, 0.5)",this._renderOverlay(t),void 0!==t.setLineDash?t.setLineDash([i,i]):void 0!==t.mozDash&&(t.mozDash=[i,i]),t.strokeStyle="rgba(0, 0, 0, 0.2)",this._renderBorders(t),this._renderGrid(t),t.lineDashOffset=i,t.strokeStyle="rgba(255, 255, 255, 0.4)",this._renderBorders(t),this._renderGrid(t),t.scale(1/s,1/a)},_renderOverlay:function(t){var i=t.canvas,e=Math.ceil(-this.getWidth()/2-this.getLeft()),n=Math.ceil(-this.getWidth()/2),s=Math.ceil(this.getWidth()/2),a=Math.ceil(this.getWidth()/2+(i.width-this.getWidth()-this.getLeft())),o=Math.ceil(-this.getHeight()/2-this.getTop()),r=Math.ceil(-this.getHeight()/2),h=Math.ceil(this.getHeight()/2),l=Math.ceil(this.getHeight()/2+(i.height-this.getHeight()-this.getTop()));t.beginPath(),t.moveTo(e-1,o-1),t.lineTo(a+1,o-1),t.lineTo(a+1,l+1),t.lineTo(e-1,l-1),t.lineTo(e-1,o-1),t.closePath(),t.moveTo(n,r),t.lineTo(n,h),t.lineTo(s,h),t.lineTo(s,r),t.lineTo(n,r),t.closePath(),t.fill()},_renderBorders:function(t){t.beginPath(),t.moveTo(-this.getWidth()/2,-this.getHeight()/2),t.lineTo(this.getWidth()/2,-this.getHeight()/2),t.lineTo(this.getWidth()/2,this.getHeight()/2),t.lineTo(-this.getWidth()/2,this.getHeight()/2),t.lineTo(-this.getWidth()/2,-this.getHeight()/2),t.stroke()},_renderGrid:function(t){}}),l=a.Plugin.inherit({startX:null,startY:null,isKeyCroping:!1,isKeyLeft:!1,isKeyUp:!1,defaults:{minHeight:1,minWidth:1,ratio:null,quickCropKey:!1},init:function(t,i){this.overrided(t,i);var e=this.imager.toolbar.createButtonGroup();this.cropButton=e.createButton({image:"crop"}),this.okButton=e.createButton({image:"done",type:"success",hide:!0}),this.cancelButton=e.createButton({image:"close",type:"danger",hide:!0}),this.cropButton.addEventListener("click",this.toggleCrop.bind(this)),this.okButton.addEventListener("click",this.cropCurrentZone.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.imager.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.imager.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.imager.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.imager.canvas.on("object:moving",this.onObjectMoving.bind(this)),this.imager.canvas.on("object:scaling",this.onObjectScaling.bind(this)),s.util.addListener(document,"keydown",this.onKeyDown.bind(this)),s.util.addListener(document,"keyup",this.onKeyUp.bind(this)),this.imager.addEventListener("core:transformation",this.releaseFocus.bind(this))},onObjectMoving:function(t){if(this.hasFocus()){var i=t.target;if(i===this.cropZone){var e=this.imager.canvas,n=i.getLeft(),s=i.getTop(),a=i.getWidth(),o=i.getHeight(),r=e.getWidth()-a,h=e.getHeight()-o;n<0&&i.set("left",0),s<0&&i.set("top",0),n>r&&i.set("left",r),s>h&&i.set("top",h),this.imager.dispatchEvent("crop:update")}}},onObjectScaling:function(t){if(this.hasFocus()){var i=!1,e=t.target;if(e===this.cropZone){var n=this.imager.canvas,s=n.getPointer(t.e),a=(s.x,s.y,e.getLeft()),o=e.getTop(),r=e.getLeft()+e.getWidth(),h=e.getTop()+e.getHeight();if(null!==this.options.ratio&&(a<0||r>n.getWidth()||o<0||h>n.getHeight())&&(i=!0),a<0||r>n.getWidth()||i){var l=this.lastScaleX||1;e.setScaleX(l)}if(a<0&&e.setLeft(0),o<0||h>n.getHeight()||i){var c=this.lastScaleY||1;e.setScaleY(c)}o<0&&e.setTop(0),e.getWidth()<this.options.minWidth&&e.scaleToWidth(this.options.minWidth),e.getHeight()<this.options.minHeight&&e.scaleToHeight(this.options.minHeight),this.lastScaleX=e.getScaleX(),this.lastScaleY=e.getScaleY(),this.imager.dispatchEvent("crop:update")}}},onMouseDown:function(t){if(this.hasFocus()){var i=this.imager.canvas;i.calcOffset();var e=i.getPointer(t.e),n=e.x,a=e.y,o=new s.Point(n,a),r=i.getActiveObject();r===this.cropZone||this.cropZone.containsPoint(o)||(i.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.startX=n,this.startY=a)}},onMouseMove:function(t){if(this.isKeyCroping)return this.onMouseMoveKeyCrop(t);if(null!==this.startX&&null!==this.startY){var i=this.imager.canvas,e=i.getPointer(t.e),n=e.x,s=e.y;this._renderCropZone(this.startX,this.startY,n,s)}},onMouseMoveKeyCrop:function(t){var i=this.imager.canvas,e=this.cropZone,n=i.getPointer(t.e),s=n.x,a=n.y;e.left&&e.top||(e.setTop(a),e.setLeft(s)),this.isKeyLeft=s<e.left+e.width/2,this.isKeyUp=a<e.top+e.height/2,this._renderCropZone(Math.min(e.left,s),Math.min(e.top,a),Math.max(e.left+e.width,s),Math.max(e.top+e.height,a))},onMouseUp:function(t){if(null!==this.startX&&null!==this.startY){var i=this.imager.canvas;this.cropZone.setCoords(),i.setActiveObject(this.cropZone),i.calcOffset(),this.startX=null,this.startY=null}},onKeyDown:function(t){!1===this.options.quickCropKey||t.keyCode!==this.options.quickCropKey||this.isKeyCroping||(this.isKeyCroping=!0,this.imager.canvas.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.cropZone.setTop(0),this.cropZone.setLeft(0))},onKeyUp:function(t){!1!==this.options.quickCropKey&&t.keyCode===this.options.quickCropKey&&this.isKeyCroping&&(this.isKeyCroping=!1,this.startX=1,this.startY=1,this.onMouseUp())},selectZone:function(t,i,e,n,s){this.hasFocus()||this.requireFocus(),s?this.cropZone.set({left:t,top:i,width:e,height:n}):this._renderCropZone(t,i,t+e,i+n);var a=this.imager.canvas;a.bringToFront(this.cropZone),this.cropZone.setCoords(),a.setActiveObject(this.cropZone),a.calcOffset(),this.imager.dispatchEvent("crop:update")},toggleCrop:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},cropCurrentZone:function(){if(this.hasFocus()&&!(this.cropZone.width<1&&this.cropZone.height<1)){var t=this.imager.image,i=this.cropZone.getTop()-t.getTop(),e=this.cropZone.getLeft()-t.getLeft(),n=this.cropZone.getWidth(),s=this.cropZone.getHeight();i<0&&(s+=i,i=0),e<0&&(n+=e,e=0),this.imager.applyTransformation(new r({top:i/t.getHeight(),left:e/t.getWidth(),width:n/t.getWidth(),height:s/t.getHeight()}))}},hasFocus:function(){return void 0!==this.cropZone},requireFocus:function(){this.cropZone=new h({fill:"transparent",hasBorders:!1,originX:"left",originY:"top",cornerColor:"#444",cornerSize:8,transparentCorners:!1,lockRotation:!0,hasRotatingPoint:!1}),null!==this.options.ratio&&this.cropZone.set("lockUniScaling",!0),this.imager.canvas.add(this.cropZone),this.imager.canvas.defaultCursor="crosshair",this.cropButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1)},releaseFocus:function(){void 0!==this.cropZone&&(this.cropZone.remove(),this.cropZone=void 0,this.cropButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.imager.canvas.defaultCursor="default",this.imager.dispatchEvent("crop:update"))},_renderCropZone:function(t,i,e,n){var s=this.imager.canvas,a=e>t,o=!a,r=n>i,h=!r,l=Math.min(+this.options.minWidth,s.getWidth()),c=Math.min(+this.options.minHeight,s.getHeight()),g=Math.min(t,e),u=Math.max(t,e),d=Math.min(i,n),m=Math.max(i,n);g=Math.max(0,g),u=Math.min(s.getWidth(),u),d=Math.max(0,d),m=Math.min(s.getHeight(),m),u-g<l&&(a?u=g+l:g=u-l),m-d<c&&(r?m=d+c:d=m-c),g<0&&(u+=Math.abs(g),g=0),u>s.getWidth()&&(g-=u-s.getWidth(),u=s.getWidth()),d<0&&(m+=Math.abs(d),d=0),m>s.getHeight()&&(d-=m-s.getHeight(),m=s.getHeight());var p=u-g,f=m-d,v=p/f;if(this.options.ratio&&+this.options.ratio!==v){var k=+this.options.ratio;if(this.isKeyCroping&&(o=this.isKeyLeft,h=this.isKeyUp),v<k){var y=f*k;o&&(g-=y-p),p=y}else if(v>k){var b=f/(k*f/p);h&&(d-=b-f),f=b}if(g<0&&(g=0),d<0&&(d=0),g+p>s.getWidth()){var y=s.getWidth()-g;f=y*f/p,p=y,h&&(d=i-f)}if(d+f>s.getHeight()){var b=s.getHeight()-d;p=p*b/f,f=b,o&&(g=t-p)}}this.cropZone.left=g,this.cropZone.top=d,this.cropZone.width=p,this.cropZone.height=f,this.imager.canvas.bringToFront(this.cropZone),this.imager.dispatchEvent("crop:update")}}),c={name:"crop",ctor:l};return a.installPlugin(c),c}),t("skylark-ui-imager/plugins/rotate",["skylark-langx/langx","skylark-utils/noder","skylark-utils/query","skylark-utils-canvas2d","../Imager"],function(t,i,e,n,s){"use strict";var a=s.Transformation.inherit({applyTransformation:function(t,i,e){var n=(i.getAngle()+this.options.angle)%360;i.rotate(n);var s,a;a=Math.abs(i.getWidth()*Math.sin(n*Math.PI/180))+Math.abs(i.getHeight()*Math.cos(n*Math.PI/180)),s=Math.abs(i.getHeight()*Math.sin(n*Math.PI/180))+Math.abs(i.getWidth()*Math.cos(n*Math.PI/180)),t.setWidth(s),t.setHeight(a),t.centerObject(i),i.setCoords(),t.renderAll(),e()}}),o=s.Plugin.inherit({init:function(t,i){this.overrided(t,i);var e=this.imager.toolbar.createButtonGroup(),n=e.createButton({image:"rotate-left"}),s=e.createButton({image:"rotate-right"});n.addEventListener("click",this.rotateLeft.bind(this)),s.addEventListener("click",this.rotateRight.bind(this))},rotateLeft:function(){this.rotate(-90)},rotateRight:function(){this.rotate(90)},rotate:function(t){this.imager.applyTransformation(new a({angle:t}))}}),r={name:"rotate",ctor:o};return s.installPlugin(r),r}),t("skylark-ui-imager/plugins/save",["skylark-langx/langx","skylark-utils/noder","skylark-utils/query","skylark-utils-canvas2d","../Imager"],function(t,i,e,n,s){"use strict";var a=s.Plugin.inherit({defaults:{callback:function(){this.imager.selfDestroy()}},init:function(t,i){this.overrided(t,i);var e=this.imager.toolbar.createButtonGroup();this.destroyButton=e.createButton({image:"save"}),this.destroyButton.addEventListener("click",this.options.callback.bind(this))}}),o={name:"save",ctor:a};return s.installPlugin(o),o}),t("skylark-ui-imager/main",["./Imager","./plugins/history","./plugins/crop","./plugins/rotate","./plugins/save"],function(t){return t}),t("skylark-ui-imager",["skylark-ui-imager/main"],function(t){return t})},this);
//# sourceMappingURL=sourcemaps/skylark-ui-imager.js.map
