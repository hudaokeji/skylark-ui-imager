/**
 * skylark-darkroomjs - A version of darkroomjs that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-darkroomjs/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-noder","skylark-domx-images","skylark-domx-query","skylark-fabric","../Darkroom"],function(t,e,i,o,s,h){"use strict";var a=h.Transformation.inherit({applyTransformation:function(t,e,o){var h=new Image,a=function(t){return{height:Math.abs(t.getScaledWidth()*Math.sin(t.get("angle")*Math.PI/180))+Math.abs(t.getScaledHeight()*Math.cos(t.get("angle")*Math.PI/180)),width:Math.abs(t.getScaledHeight()*Math.sin(t.get("angle")*Math.PI/180))+Math.abs(t.getScaledWidth()*Math.cos(t.get("angle")*Math.PI/180))}}(e),n=a.width,r=a.height,c=this.options.left*n,l=this.options.top*r,d=Math.min(this.options.width*n,n-c),g=Math.min(this.options.height*r,r-l);h.src=t.toDataURL({left:c,top:l,width:d,height:g}),i.loaded(h).then(function(){if(!(n<1||a<1)){var i=new s.Image(h,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),a=h.width,n=h.height;t.setWidth(a),t.setHeight(n),t.remove(e),t.add(i),o(i)}})}}),n=s.util.createClass(s.Rect,{_render:function(t){this.callSuper("_render",t);t.canvas;var e=this.flipX?-1:1,i=this.flipY?-1:1,o=e/this.scaleX,s=i/this.scaleY;t.scale(o,s),this._renderOverlay(t),void 0!==t.setLineDash?t.setLineDash([7,7]):void 0!==t.mozDash&&(t.mozDash=[7,7]),t.strokeStyle="rgba(0, 0, 0, 0.2)",this._renderBorders(t),this._renderGrid(t),t.lineDashOffset=7,t.strokeStyle="rgba(255, 255, 255, 0.4)",this._renderBorders(t),this._renderGrid(t),t.scale(1/o,1/s)},_renderOverlay:function(t){var e=t.canvas,i=Math.ceil(-this.getScaledWidth()/2-this.left),o=Math.ceil(-this.getScaledWidth()/2),s=Math.ceil(this.getScaledWidth()/2),h=Math.ceil(this.getScaledWidth()/2+(e.width-this.getScaledWidth()-this.left)),a=Math.ceil(-this.getScaledHeight()/2-this.top),n=Math.ceil(-this.getScaledHeight()/2),r=Math.ceil(this.getScaledHeight()/2),c=Math.ceil(this.getScaledHeight()/2+(e.height-this.getScaledHeight()-this.top));t.beginPath(),t.moveTo(i-1,a-1),t.lineTo(h+1,a-1),t.lineTo(h+1,c+1),t.lineTo(i-1,c-1),t.lineTo(i-1,a-1),t.closePath(),t.moveTo(o,n),t.lineTo(o,r),t.lineTo(s,r),t.lineTo(s,n),t.lineTo(o,n),t.closePath(),t.fill()},_renderBorders:function(t){t.beginPath(),t.moveTo(-this.getScaledWidth()/2,-this.getScaledHeight()/2),t.lineTo(this.getScaledWidth()/2,-this.getScaledHeight()/2),t.lineTo(this.getScaledWidth()/2,this.getScaledHeight()/2),t.lineTo(-this.getScaledWidth()/2,this.getScaledHeight()/2),t.lineTo(-this.getScaledWidth()/2,-this.getScaledHeight()/2),t.stroke()},_renderGrid:function(t){t.beginPath(),t.moveTo(-this.getScaledWidth()/2+1/3*this.getScaledWidth(),-this.getScaledHeight()/2),t.lineTo(-this.getScaledWidth()/2+1/3*this.getScaledWidth(),this.getScaledHeight()/2),t.stroke(),t.beginPath(),t.moveTo(-this.getScaledWidth()/2+2/3*this.getScaledWidth(),-this.getScaledHeight()/2),t.lineTo(-this.getScaledWidth()/2+2/3*this.getScaledWidth(),this.getScaledHeight()/2),t.stroke(),t.beginPath(),t.moveTo(-this.getScaledWidth()/2,-this.getScaledHeight()/2+1/3*this.getScaledHeight()),t.lineTo(this.getScaledWidth()/2,-this.getScaledHeight()/2+1/3*this.getScaledHeight()),t.stroke(),t.beginPath(),t.moveTo(-this.getScaledWidth()/2,-this.getScaledHeight()/2+2/3*this.getScaledHeight()),t.lineTo(this.getScaledWidth()/2,-this.getScaledHeight()/2+2/3*this.getScaledHeight()),t.stroke()}}),r={name:"crop",ctor:h.Plugin.inherit({startX:null,startY:null,isKeyCroping:!1,isKeyLeft:!1,isKeyUp:!1,defaults:{minHeight:1,minWidth:1,ratio:null,quickCropKey:!1},init:function(t,e){this.overrided(t,e);var i=this.Darkroom.toolbar.createButtonGroup();this.cropButton=i.createButton({image:"crop"}),this.okButton=i.createButton({image:"done",type:"success",hide:!0}),this.cancelButton=i.createButton({image:"close",type:"danger",hide:!0}),this.cropButton.addEventListener("click",this.toggleCrop.bind(this)),this.okButton.addEventListener("click",this.cropCurrentZone.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.Darkroom.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.Darkroom.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.Darkroom.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.Darkroom.canvas.on("object:moving",this.onObjectMoving.bind(this)),this.Darkroom.canvas.on("object:scaling",this.onObjectScaling.bind(this)),s.util.addListener(document,"keydown",this.onKeyDown.bind(this)),s.util.addListener(document,"keyup",this.onKeyUp.bind(this)),this.Darkroom.addEventListener("core:transformation",this.releaseFocus.bind(this))},onObjectMoving:function(t){if(this.hasFocus()){var e=t.target;if(e===this.cropZone){var i=this.Darkroom.canvas,o=e.left,s=e.top,h=e.getScaledWidth(),a=e.getScaledHeight(),n=i.getWidth()-h,r=i.getHeight()-a;o<0&&e.set("left",0),s<0&&e.set("top",0),o>n&&e.set("left",n),s>r&&e.set("top",r),this.Darkroom.dispatchEvent("crop:update")}}},onObjectScaling:function(t){if(this.hasFocus()){var e=!1,i=t.target;if(i===this.cropZone){var o=this.Darkroom.canvas,s=o.getPointer(t.e),h=(s.x,s.y,i.left),a=i.top,n=i.left+i.getScaledWidth(),r=i.top+i.getScaledHeight();if(null!==this.options.ratio&&(h<0||n>o.getWidth()||a<0||r>o.getHeight())&&(e=!0),h<0||n>o.getWidth()||e){var c=this.lastScaleX||1;i.setScaleX(c)}if(h<0&&i.setLeft(0),a<0||r>o.getHeight()||e){var l=this.lastScaleY||1;i.setScaleY(l)}a<0&&i.setTop(0),i.get("width")<this.options.minWidth&&i.scaleToWidth(this.options.minWidth),i.get("height")<this.options.minHeight&&i.scaleToHeight(this.options.minHeight),this.lastScaleX=i.get("scaleX"),this.lastScaleY=i.get("scaleY"),this.Darkroom.dispatchEvent("crop:update")}}},onMouseDown:function(t){if(this.hasFocus()){var e=this.Darkroom.canvas;e.calcOffset();var i=e.getPointer(t.e),o=i.x,h=i.y,a=new s.Point(o,h);e.getActiveObject()===this.cropZone||this.cropZone.containsPoint(a)||(e.discardActiveObject(),this.cropZone.set("width",0),this.cropZone.set("height",0),this.cropZone.set("scaleX",1),this.cropZone.set("scaleY",1),this.startX=o,this.startY=h)}},onMouseMove:function(t){if(this.isKeyCroping)return this.onMouseMoveKeyCrop(t);if(null!==this.startX&&null!==this.startY){var e=this.Darkroom.canvas.getPointer(t.e),i=e.x,o=e.y;this._renderCropZone(this.startX,this.startY,i,o)}},onMouseMoveKeyCrop:function(t){var e=this.Darkroom.canvas,i=this.cropZone,o=e.getPointer(t.e),s=o.x,h=o.y;i.left&&i.top||(i.set("top",h),i.set("left",s)),this.isKeyLeft=s<i.left+i.width/2,this.isKeyUp=h<i.top+i.height/2,this._renderCropZone(Math.min(i.left,s),Math.min(i.top,h),Math.max(i.left+i.width,s),Math.max(i.top+i.height,h))},onMouseUp:function(t){if(null!==this.startX&&null!==this.startY){var e=this.Darkroom.canvas;this.cropZone.setCoords(),e.setActiveObject(this.cropZone),e.calcOffset(),this.startX=null,this.startY=null}},onKeyDown:function(t){!1===this.options.quickCropKey||t.keyCode!==this.options.quickCropKey||this.isKeyCroping||(this.isKeyCroping=!0,this.Darkroom.canvas.discardActiveObject(),this.cropZone.set("width",0),this.cropZone.set("height",0),this.cropZone.set("scaleX",1),this.cropZone.set("scaleY",1),this.cropZone.set("top",0),this.cropZone.set("left",0))},onKeyUp:function(t){!1!==this.options.quickCropKey&&t.keyCode===this.options.quickCropKey&&this.isKeyCroping&&(this.isKeyCroping=!1,this.startX=1,this.startY=1,this.onMouseUp())},selectZone:function(t,e,i,o,s){this.hasFocus()||this.requireFocus(),s?this.cropZone.set({left:t,top:e,width:i,height:o}):this._renderCropZone(t,e,t+i,e+o);var h=this.Darkroom.canvas;h.bringToFront(this.cropZone),this.cropZone.setCoords(),h.setActiveObject(this.cropZone),h.calcOffset(),this.Darkroom.dispatchEvent("crop:update")},toggleCrop:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},cropCurrentZone:function(){if(this.hasFocus()&&!(this.cropZone.width<1&&this.cropZone.height<1)){var t=this.Darkroom.image,e=this.cropZone.get("top")-t.get("top"),i=this.cropZone.get("left")-t.get("left"),o=this.cropZone.get("width"),s=this.cropZone.get("height");e<0&&(s+=e,e=0),i<0&&(o+=i,i=0),this.Darkroom.applyTransformation(new a({top:e/t.getScaledHeight(),left:i/t.getScaledWidth(),width:o/t.getScaledWidth(),height:s/t.getScaledHeight()}))}},hasFocus:function(){return void 0!==this.cropZone},requireFocus:function(){this.cropZone=new n({fill:"transparent",hasBorders:!1,originX:"left",originY:"top",cornerColor:"#444",cornerSize:8,transparentCorners:!1,lockRotation:!0,hasRotatingPoint:!1}),null!==this.options.ratio&&this.cropZone.set("lockUniScaling",!0),this.Darkroom.canvas.add(this.cropZone),this.Darkroom.canvas.defaultCursor="crosshair",this.cropButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1)},releaseFocus:function(){void 0!==this.cropZone&&(this.cropZone.canvas.remove(this.cropZone),this.cropZone=void 0,this.cropButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.Darkroom.canvas.defaultCursor="default",this.Darkroom.dispatchEvent("crop:update"))},_renderCropZone:function(t,e,i,o){var s=this.Darkroom.canvas,h=i>t,a=!h,n=o>e,r=!n,c=Math.min(+this.options.minWidth,s.getWidth()),l=Math.min(+this.options.minHeight,s.getHeight()),d=Math.min(t,i),g=Math.max(t,i),p=Math.min(e,o),u=Math.max(e,o);d=Math.max(0,d),g=Math.min(s.getWidth(),g),p=Math.max(0,p),u=Math.min(s.getHeight(),u),g-d<c&&(h?g=d+c:d=g-c),u-p<l&&(n?u=p+l:p=u-l),d<0&&(g+=Math.abs(d),d=0),g>s.getWidth()&&(d-=g-s.getWidth(),g=s.getWidth()),p<0&&(u+=Math.abs(p),p=0),u>s.getHeight()&&(p-=u-s.getHeight(),u=s.getHeight());var v=g-d,f=u-p,m=v/f;if(this.options.ratio&&+this.options.ratio!==m){var S=+this.options.ratio;if(this.isKeyCroping&&(a=this.isKeyLeft,r=this.isKeyUp),m<S){var k=f*S;a&&(d-=k-v),v=k}else if(m>S){var M=f/(S*f/v);r&&(p-=M-f),f=M}if(d<0&&(d=0),p<0&&(p=0),d+v>s.getWidth())f=(k=s.getWidth()-d)*f/v,v=k,r&&(p=e-f);if(p+f>s.getHeight())v=v*(M=s.getHeight()-p)/f,f=M,a&&(d=t-v)}this.cropZone.left=d,this.cropZone.top=p,this.cropZone.width=v,this.cropZone.height=f,this.Darkroom.canvas.bringToFront(this.cropZone),this.Darkroom.dispatchEvent("crop:update")}})};return h.installPlugin(r),r});
//# sourceMappingURL=../sourcemaps/plugins/crop.js.map
